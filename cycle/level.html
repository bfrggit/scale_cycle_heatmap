<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Googlemaps Heatmap Layer</title>
    <style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
      #tool { top: 0; position: absolute; padding: 10px; }
      h1 { position:absolute; }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="js/heatmap.js"></script>
    <script src="js/gmaps-heatmap.js"></script>
  </head>
  <body>
    <!--<h1>Gmaps Heatmap Overlay Example</h1>-->
    <div id="tool">
      <fieldset>
          <label for="csvFileInput"> <strong>CSV File:</strong>
          </label>
          <input type="file" id="csvFileInput" onchange="handleFiles(this.files)"
          accept=".csv">
      </fieldset>
    </div>
    <div id="map-canvas"></div>
  
  <script type="text/javascript">
function handleFiles(files) {
  // Check for the various File API support.
  if (window.FileReader) {
    // FileReader are supported.
    getAsText(files[0]);
  } else {
    alert('FileReader is not supported in this browser.');
  }
}

function getAsText(fileToRead) {
  var reader = new FileReader();
  // Handle errors load
  reader.onload = loadHandler;
  reader.onerror = errorHandler;
  // Read file into memory as UTF-8      
  reader.readAsText(fileToRead);
}

function loadHandler(event) {
  var csv = event.target.result;
  processData(csv);             
}

function processData(csv) {
    var allTextLines = csv.split(/\r\n|\n/);
    var lines = [];
    while (allTextLines.length) {
        lines.push(allTextLines.shift().split(','));
    }
  console.log(lines);
  drawOutput(lines);
}

function errorHandler(evt) {
  if(evt.target.error.name == "NotReadableError") {
    alert("Cannot read file!");
  }
}

// function drawOutput(lines){
//   //Clear previous data
//   document.getElementById("output").innerHTML = "";
//   var table = document.createElement("table");
//   for (var i = 0; i < lines.length; i++) {
//     var row = table.insertRow(-1);
//     for (var j = 0; j < lines[i].length; j++) {
//       var firstNameCell = row.insertCell(-1);
//       firstNameCell.appendChild(document.createTextNode(lines[i][j]));
//     }
//   }
//   document.getElementById("output").appendChild(table);
// }

function isNormalInteger(str) {
  var n = ~~Number(str);
  return String(n) === str && n >= 0;
}

function drawOutput(lines){
  var items = [];
  for (var i = 0; i < lines.length; ++i) {
    var row = {};
    str_lon = lines[i][2];
    str_lat = lines[i][3];
    str_count = lines[i][6];
    if (!isNormalInteger(str_count)) continue;
    row["lng"] = parseFloat(str_lon);
    row["lat"] = parseFloat(str_lat);
    row["count"] = parseInt(str_count);
    items.push(row);
  }
  console.log(items);
  drawMap(items);
}
  </script>

  <script>
function drawMap(items){
  // map center: Aldrich Park, University of California, Irvine
  var myLatlng = new google.maps.LatLng(33.646052, -117.842745);
  // map options,
  var myOptions = {
    zoom: 16,
    center: myLatlng
  };
  // standard map
  map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
  // heatmap layer
  heatmap = new HeatmapOverlay(map, 
    {
      // radius should be small ONLY if scaleRadius is true (or small radius is intended)
      "radius": 0.00008,
      "maxOpacity": 0.5, 
      // scales the radius based on map zoom
      "scaleRadius": true, 
      // if set to false the heatmap uses the global maximum for colorization
      // if activated: uses the data maximum within the current map boundaries 
      //   (there will always be a red spot with useLocalExtremas true)
      "useLocalExtrema": true,
      // which field name in your data represents the latitude - default "lat"
      latField: 'lat',
      // which field name in your data represents the longitude - default "lng"
      lngField: 'lng',
      // which field name in your data represents the data value - default "value"
      valueField: 'count'
    }
  );

  var testData = {
    max: 100,
    data: items
  }

  heatmap.setData(testData);
};
  </script>
  </body>
</html>
