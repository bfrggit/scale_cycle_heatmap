<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Google Maps Example</title>
    <style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
      h1 { position:absolute; }
      #tool { top: 0; position: absolute; padding: 10px; }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
  </head>
  <body>
    <div id="tool">
      <fieldset>
          <label for="csvFileInput"> <strong>CSV File:</strong>
          </label>
          <input type="file" id="csvFileInput" onchange="handleFiles(this.files)"
          accept=".csv">
      </fieldset>
    </div>
    <div id="map-canvas"></div>
    
    <script type="text/javascript">
function handleFiles(files) {
  // Check for the various File API support.
  if (window.FileReader) {
    // FileReader are supported.
    getAsText(files[0]);
  } else {
    alert('FileReader is not supported in this browser.');
  }
}

function getAsText(fileToRead) {
  var reader = new FileReader();
  // Handle errors load
  reader.onload = loadHandler;
  reader.onerror = errorHandler;
  // Read file into memory as UTF-8      
  reader.readAsText(fileToRead);
}

function loadHandler(event) {
  var csv = event.target.result;
  processData(csv);             
}

function processData(csv) {
    var allTextLines = csv.split(/\r\n|\n/);
    var lines = [];
    while (allTextLines.length) {
        lines.push(allTextLines.shift().split(','));
    }
  console.log(lines);
  drawOutput(lines);
}

function errorHandler(evt) {
  if(evt.target.error.name == "NotReadableError") {
    alert("Cannot read file!");
  }
}

// function drawOutput(lines){
//   //Clear previous data
//   document.getElementById("output").innerHTML = "";
//   var table = document.createElement("table");
//   for (var i = 0; i < lines.length; i++) {
//     var row = table.insertRow(-1);
//     for (var j = 0; j < lines[i].length; j++) {
//       var firstNameCell = row.insertCell(-1);
//       firstNameCell.appendChild(document.createTextNode(lines[i][j]));
//     }
//   }
//   document.getElementById("output").appendChild(table);
// }

function isNormalInteger(str) {
  var n = ~~Number(str);
  return String(n) === str && n >= 0;
}

function isFloat(val) {
  if(!val || (typeof val != "string" || val.constructor != String)) {
    return(false);
  }
  var isNumber = !isNaN(new Number(val));
  if(isNumber) {
    if(val.indexOf('.') != -1) {
      return(true);
    } else {
      return(false);
    }
  } else {
    return(false);
  }
}

function drawOutput(lines){
  var items = [];
  for (var i = 0; i < lines.length; ++i) {
    var row = {};
    str_lon = lines[i][2];
    str_lat = lines[i][3];
    if (!isFloat(str_lon) || !isFloat(str_lat)) continue;
    items.push(new google.maps.LatLng(parseFloat(str_lat), parseFloat(str_lon)));
  }
  console.log(items);
  drawMap(items);
}
    </script>

    <script>
function squareDist(pFrom, pTo){
  return (pFrom.lat()-pTo.lat())*(pFrom.lat()-pTo.lat())
    +(pFrom.lng()-pTo.lng())*(pFrom.lng()-pTo.lng());
}

function drawMap(items){
  // map center: Aldrich Park, University of California, Irvine
  var myLatlng = new google.maps.LatLng(33.646052, -117.842745);
  // map options
  var myOptions = {
    zoom: 16,
    center: myLatlng
  };
  // standard map
  map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

  var markerDot = {
    url: "img/red_dot.png",
    size: new google.maps.Size(9, 9),
    // The origin for this image is 0,0.
    origin: new google.maps.Point(0, 0),
    anchor: new google.maps.Point(4, 4)
  }

  // To add the marker to the map, use the 'map' property
  // var marker = new google.maps.Marker({
  //     position: new google.maps.LatLng(33.646052, -117.842745),
  //     map: map,
  //     title:"Aldrich Park"
  // });

  var segments = [];
  var segDist = 0.0003;
  var connects = [];

  for (var i = 0; i < items.length; ++i) {
    if(i == 0 || squareDist(items[i-1], items[i]) > segDist*segDist){
      segments.push([]);
      if(i > 0){
        connects.push([
          items[i-1],
          items[i]
        ]);
      }
    }
    segThis = segments[segments.length-1];
    segThis.push(items[i]);
  }

  for (var i = 0; i < segments.length; ++i) {
    // new google.maps.Marker({
    //   position: segments[i][0],
    //   icon: markerDot,
    //   map: map
    // });
    if(segments[i].length > 1){
      new google.maps.Polyline({
        path: segments[i],
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 5,
        map: map
      });
    } else {
      new google.maps.Marker({
        position: segments[i][0],
        icon: markerDot,
        map: map
      });
    }
  }

  for (var i = 0; i < connects.length; ++i) {
    new google.maps.Polyline({
      path: connects[i],
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2,
      map: map
    });
  }
};
    </script>
  </body>
</html>